
# create an BWA index from the reference transcriptome
bwa index subsamp.imitator.merged.fasta

# list samples to work with *these are all in the rcorr/ directory, and have already been trimmed/error corrected)
cd rcorr/
samples=$(ls *P.cor.fq.gz | sed "s/.TRIM_1P.cor.fq.gz//g" | sed "s/.TRIM_2P.cor.fq.gz//g" | uniq  | grep -v subsamp)
echo $samples

# Map individual samples to reference transcriptome using BWA
cd ..
mkdir bambams
for i in $samples; do
    bwa mem subsamp.imitator.merged.fasta  -t 24 \
    rcorr/$i.TRIM_1P.cor.fq.gz \
    rcorr/$i.TRIM_2P.cor.fq.gz > bambams/$i.sam
done

# define picard path for next steps
PICARD=$"/home/summersk/programs/picard-2.18.5/picard.jar"

# define samples, these are the same as above
sammies=$(ls bambams/*.sam | sed "s/.sam//g")

# run picard to produce sorted sam files
parallel -j 12 java -jar $PICARD SortSam INPUT={}.sam OUTPUT={}_sorted_reads.bam SORT_ORDER=coordinate ::: $sammies

# Mark duplicates here
sorted=$(ls bambams/*_sorted_reads.bam | sed "s/_sorted_reads.bam//g")
parallel -j 8 java -jar $PICARD MarkDuplicates INPUT={}_sorted_reads.bam OUTPUT={}_dedup_reads.bam METRICS_FILE={}_metrics.txt MAX_FILE_HANDLES_FOR_READ_ENDS_MAP=500 ::: $sorted

# Add group information to files
dedupd=$(ls bambams/*_dedup_reads.bam | sed "s/_dedup_reads.bam//g")
parallel -j 16 java -jar $PICARD AddOrReplaceReadGroups  I={}_dedup_reads.bam O={}_dedup_reads2.bam RGLB=lib1 RGPL=illumina RGPU=unit1 RGSM={} ::: $dedupd


# Build the index using BAM for each file
dedupd=$(ls bambams/*_dedup_reads2.bam | sed "s/_dedup_reads2.bam//g")
parallel -j 16 java -jar $PICARD BuildBamIndex INPUT={}_dedup_reads2.bam ::: $dedupd



###### currently running above

######### this????
samtools faidx subsamp.imitator.merged.fasta


# Merge these files together
samtools merge merged.bam bambams/*dedup_reads2.bam #### WHAT IS THE OUTPUT OF THE ABOVE??
 
# Index the merged file using samtools
samtools index merged.bam
